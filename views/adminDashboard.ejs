<%- include('partials/header') %>

<section id="admin-dashboard" class="admin-dashboard-section">
  <div class="container">
    <div class="dashboard-header">
      <div class="header-content">
        <i class="fas fa-cogs dashboard-icon"></i>
        <h2>Portfolio Management Dashboard</h2>
      </div>
      <div class="admin-actions">
        <a href="/" class="view-site-btn" target="_blank">
          <i class="fas fa-external-link-alt"></i>
          View Site
        </a>
        <a href="/admin/logout" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </a>
      </div>
    </div>

    <div class="dashboard-stats">
      <div class="stat-card">
        <i class="fas fa-folder-open"></i>
        <h3><%= projects.length %></h3>
        <p>Projects</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-trophy"></i>
        <h3><%= awards.length %></h3>
        <p>Achievements</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-envelope"></i>
        <h3><%= messages.length %></h3>
        <p>Messages</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-cubes"></i>
        <h3><%= techstack.length %></h3>
        <p>Tech Categories</p>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Projects Management -->
      <div class="management-section">
        <div class="section-header">
          <h3><i class="fas fa-folder-open"></i> Projects Management</h3>
          <button class="add-btn" onclick="showAddProjectModal()">
            <i class="fas fa-plus"></i> Add Project
          </button>
        </div>
        
        <div class="content-grid">
          <% projects.forEach((project, index) => { %>
            <div class="content-card">
              <div class="card-header">
                <h4><%= project.title %></h4>
                <div class="card-actions">
                  <button class="edit-btn" onclick="editProject('<%= project._id %>')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-btn" onclick="deleteProject('<%= project._id %>')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <p class="card-description"><%= project.description %></p>
              <div class="card-tags">
                <span class="tag"><%= project.skills %></span>
                <span class="tag"><%= project.category %></span>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Achievements Management -->
      <div class="management-section">
        <div class="section-header">
          <h3><i class="fas fa-trophy"></i> Achievements Management</h3>
          <button class="add-btn" onclick="showAddAchievementModal()">
            <i class="fas fa-plus"></i> Add Achievement
          </button>
        </div>
        
        <div class="content-grid">
          <% awards.forEach((award, index) => { %>
            <div class="content-card">
              <div class="card-header">
                <h4><%= award.title %></h4>
                <div class="card-actions">
                  <button class="edit-btn" onclick="editAchievement('<%= award._id %>')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-btn" onclick="deleteAchievement('<%= award._id %>')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <p class="card-description"><%= award.description %></p>
              <div class="card-tags">
                <span class="tag"><%= award.event %></span>
                <span class="tag"><%= award.category %></span>
                <span class="tag"><%= award.date %></span>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Tech Stack Management -->
      <div class="management-section">
        <div class="section-header">
          <h3><i class="fas fa-cubes"></i> Tech Stack Management</h3>
          <button class="add-btn" onclick="showAddTechModal()">
            <i class="fas fa-plus"></i> Add Tech Category
          </button>
        </div>
        
        <div class="content-grid">
          <% techstack.forEach((category, catIndex) => { %>
            <div class="content-card">
              <div class="card-header">
                <h4><%= category.category %></h4>
                <div class="card-actions">
                  <button class="edit-btn" onclick="editTechCategory('<%= category._id %>')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-btn" onclick="deleteTechCategory('<%= category._id %>')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="tech-items">
                <% category.items.forEach((item, itemIndex) => { %>
                  <span class="tech-item">
                    <%= item.name %>
                    <button class="remove-tech" onclick="removeTechItem('<%= category._id %>', '<%= itemIndex %>')">
                      <i class="fas fa-times"></i>
                    </button>
                  </span>
                <% }); %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- About Section Management -->
      <div class="management-section">
        <div class="section-header">
          <h3><i class="fas fa-user"></i> About Section</h3>
          <button class="edit-btn" onclick="editAboutSection()">
            <i class="fas fa-edit"></i> Edit About
          </button>
        </div>
        
        <div class="about-preview">
          <h4>Current About Content:</h4>
          <div class="about-content">
            <p>I'm <strong>Sushant Bhairu Awalekar</strong>, a B.Tech Computer Science student at <strong>TKIET Warananagar</strong>...</p>
            <p>I'm deeply passionate about <strong>AI, web development, and digital transformation</strong>...</p>
            <p>I'm always exploring new technologies, seeking opportunities to grow...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Add Project Modal -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="projectModalTitle">Add New Project</h3>
      <span class="close" onclick="closeModal('projectModal')">&times;</span>
    </div>
    <form id="projectForm" action="/admin/projects" method="POST">
      <input type="hidden" id="projectId" name="id">
      <div class="form-group">
        <label for="projectTitle">Project Title *</label>
        <input type="text" id="projectTitle" name="title" required>
      </div>
      <div class="form-group">
        <label for="projectDescription">Description *</label>
        <textarea id="projectDescription" name="description" rows="3" required></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="projectSkills">Skills *</label>
          <input type="text" id="projectSkills" name="skills" placeholder="e.g., React, Node.js, MongoDB" required>
        </div>
        <div class="form-group">
          <label for="projectCategory">Category</label>
          <input type="text" id="projectCategory" name="category" placeholder="e.g., Web App, Mobile App">
        </div>
      </div>
      <div class="form-group">
        <label for="projectLink">GitHub Link</label>
        <input type="url" id="projectLink" name="link" placeholder="https://github.com/...">
      </div>
      <div class="form-group">
        <label for="projectImage">Image URL</label>
        <input type="url" id="projectImage" name="image" placeholder="https://...">
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal('projectModal')">Cancel</button>
        <button type="submit" class="save-btn" id="projectSaveBtn">Save Project</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Achievement Modal -->
<div id="achievementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="achievementModalTitle">Add New Achievement</h3>
      <span class="close" onclick="closeModal('achievementModal')">&times;</span>
    </div>
    <form id="achievementForm" action="/admin/achievements" method="POST">
      <input type="hidden" id="achievementId" name="id">
      <div class="form-group">
        <label for="achievementTitle">Achievement Title *</label>
        <input type="text" id="achievementTitle" name="title" required>
      </div>
      <div class="form-group">
        <label for="achievementEvent">Event/Organization *</label>
        <input type="text" id="achievementEvent" name="event" required>
      </div>
      <div class="form-group">
        <label for="achievementDescription">Description *</label>
        <textarea id="achievementDescription" name="description" rows="3" required></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="achievementCategory">Category</label>
          <input type="text" id="achievementCategory" name="category" placeholder="e.g., Competition, Research">
        </div>
        <div class="form-group">
          <label for="achievementDate">Date</label>
          <input type="text" id="achievementDate" name="date" placeholder="e.g., 2024">
        </div>
      </div>
      <div class="form-group">
        <label for="achievementImage">Image URL</label>
        <input type="url" id="achievementImage" name="image" placeholder="https://...">
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal('achievementModal')">Cancel</button>
        <button type="submit" class="save-btn" id="achievementSaveBtn">Save Achievement</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Tech Category Modal -->
<div id="techModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="techModalTitle">Add New Tech Category</h3>
      <span class="close" onclick="closeModal('techModal')">&times;</span>
    </div>
    <form id="techForm" action="/admin/tech-categories" method="POST">
      <input type="hidden" id="techId" name="id">
      <div class="form-group">
        <label for="techCategory">Category Name *</label>
        <input type="text" id="techCategory" name="category" required>
      </div>
      <div class="form-group">
        <label for="techIcon">Icon (Emoji)</label>
        <input type="text" id="techIcon" name="icon" placeholder="e.g., ðŸ’», âš™ï¸, ðŸ—„ï¸">
      </div>
      <div class="form-group">
        <label for="techItems">Tech Items (comma separated) *</label>
        <textarea id="techItems" name="items" rows="3" placeholder="e.g., HTML5, CSS3, JavaScript, React" required></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal('techModal')">Cancel</button>
        <button type="submit" class="save-btn" id="techSaveBtn">Save Tech Category</button>
      </div>
    </form>
  </div>
</div>

<!-- About Section Modal -->
<div id="aboutModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit About Section</h3>
      <span class="close" onclick="closeModal('aboutModal')">&times;</span>
    </div>
    <form id="aboutForm" action="/admin/about" method="POST">
      <div class="form-group">
        <label for="aboutName">Your Name *</label>
        <input type="text" id="aboutName" name="name" value="Sushant Bhairu Awalekar" required>
      </div>
      <div class="form-group">
        <label for="aboutTitle">Title/Position *</label>
        <input type="text" id="aboutTitle" name="title" value="B.Tech Computer Science Student" required>
      </div>
      <div class="form-group">
        <label for="aboutInstitution">Institution *</label>
        <input type="text" id="aboutInstitution" name="institution" value="TKIET Warananagar" required>
      </div>
      <div class="form-group">
        <label for="aboutDescription">About Description *</label>
        <textarea id="aboutDescription" name="description" rows="6" required>I'm Sushant Bhairu Awalekar, a B.Tech Computer Science student at TKIET Warananagar. I'm deeply passionate about AI, web development, and digital transformation. I'm always exploring new technologies, seeking opportunities to grow and contribute to innovative projects.</textarea>
      </div>
      <div class="form-group">
        <label for="aboutSkills">Key Skills (comma separated)</label>
        <input type="text" id="aboutSkills" name="skills" value="AI, Web Development, Digital Transformation" placeholder="e.g., AI, Web Development, Digital Transformation">
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal('aboutModal')">Cancel</button>
        <button type="submit" class="save-btn">Save About Section</button>
      </div>
    </form>
  </div>
</div>

<script>
// Modal functions
function showAddProjectModal() {
  document.getElementById('projectModalTitle').textContent = 'Add New Project';
  document.getElementById('projectForm').reset();
  document.getElementById('projectId').value = '';
  document.getElementById('projectSaveBtn').textContent = 'Save Project';
  document.getElementById('projectModal').style.display = 'block';
}

function showAddAchievementModal() {
  document.getElementById('achievementModalTitle').textContent = 'Add New Achievement';
  document.getElementById('achievementForm').reset();
  document.getElementById('achievementId').value = '';
  document.getElementById('achievementSaveBtn').textContent = 'Save Achievement';
  document.getElementById('achievementModal').style.display = 'block';
}

function showAddTechModal() {
  document.getElementById('techModalTitle').textContent = 'Add New Tech Category';
  document.getElementById('techForm').reset();
  document.getElementById('techId').value = '';
  document.getElementById('techSaveBtn').textContent = 'Save Tech Category';
  document.getElementById('techModal').style.display = 'block';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
}

// CRUD functions
function editProject(id) {
  // Fetch project data and populate form
  fetch(`/admin/projects/${id}`)
    .then(response => response.json())
    .then(project => {
      document.getElementById('projectModalTitle').textContent = 'Edit Project';
      document.getElementById('projectId').value = project._id;
      document.getElementById('projectTitle').value = project.title;
      document.getElementById('projectDescription').value = project.description;
      document.getElementById('projectSkills').value = project.skills;
      document.getElementById('projectCategory').value = project.category || '';
      document.getElementById('projectLink').value = project.link || '';
      document.getElementById('projectImage').value = project.image || '';
      document.getElementById('projectSaveBtn').textContent = 'Update Project';
      document.getElementById('projectModal').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching project:', error);
      alert('Error loading project data');
    });
}

function deleteProject(id) {
  if (confirm('Are you sure you want to delete this project?')) {
    fetch(`/admin/projects/${id}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error deleting project: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting project');
      });
  }
}

function editAchievement(id) {
  // Fetch achievement data and populate form
  fetch(`/admin/achievements/${id}`)
    .then(response => response.json())
    .then(achievement => {
      document.getElementById('achievementModalTitle').textContent = 'Edit Achievement';
      document.getElementById('achievementId').value = achievement._id;
      document.getElementById('achievementTitle').value = achievement.title;
      document.getElementById('achievementEvent').value = achievement.event;
      document.getElementById('achievementDescription').value = achievement.description;
      document.getElementById('achievementCategory').value = achievement.category || '';
      document.getElementById('achievementDate').value = achievement.date || '';
      document.getElementById('achievementImage').value = achievement.image || '';
      document.getElementById('achievementSaveBtn').textContent = 'Update Achievement';
      document.getElementById('achievementModal').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching achievement:', error);
      alert('Error loading achievement data');
    });
}

function deleteAchievement(id) {
  if (confirm('Are you sure you want to delete this achievement?')) {
    fetch(`/admin/achievements/${id}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error deleting achievement: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting achievement');
      });
  }
}

function editAboutSection() {
  document.getElementById('aboutModal').style.display = 'block';
}

function editTechCategory(id) {
  // Fetch tech category data and populate form
  fetch(`/admin/tech-categories/${id}`)
    .then(response => response.json())
    .then(category => {
      document.getElementById('techModalTitle').textContent = 'Edit Tech Category';
      document.getElementById('techId').value = category._id;
      document.getElementById('techCategory').value = category.category;
      document.getElementById('techIcon').value = category.icon || '';
      document.getElementById('techItems').value = category.items.map(item => item.name).join(', ');
      document.getElementById('techSaveBtn').textContent = 'Update Tech Category';
      document.getElementById('techModal').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching tech category:', error);
      alert('Error loading tech category data');
    });
}

function deleteTechCategory(id) {
  if (confirm('Are you sure you want to delete this tech category?')) {
    fetch(`/admin/tech-categories/${id}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error deleting tech category: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting tech category');
      });
  }
}

function removeTechItem(catId, itemIndex) {
  if (confirm('Are you sure you want to remove this tech item?')) {
    fetch(`/admin/tech-items/${catId}/${itemIndex}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error removing tech item: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error removing tech item');
      });
  }
}

// Form submission handlers
document.getElementById('projectForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  const projectId = data.id;
  
  const url = projectId ? `/admin/projects/${projectId}` : '/admin/projects';
  const method = projectId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeModal('projectModal');
      location.reload();
    } else {
      alert('Error saving project: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving project');
  });
});

document.getElementById('achievementForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  const achievementId = data.id;
  
  const url = achievementId ? `/admin/achievements/${achievementId}` : '/admin/achievements';
  const method = achievementId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeModal('achievementModal');
      location.reload();
    } else {
      alert('Error saving achievement: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving achievement');
  });
});

document.getElementById('techForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  const techId = data.id;
  
  const url = techId ? `/admin/tech-categories/${techId}` : '/admin/tech-categories';
  const method = techId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeModal('techModal');
      location.reload();
    } else {
      alert('Error saving tech category: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error saving tech category');
  });
});

// About form handler
document.getElementById('aboutForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  fetch('/admin/about', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeModal('aboutModal');
      alert('About section updated successfully!');
    } else {
      alert('Error updating about section: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error updating about section');
  });
});
</script>

<%- include('partials/footer') %> 